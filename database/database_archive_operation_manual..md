# データベース長期保管データ アーカイブおよび削除 運用要領書

本資料は、生成AIを使って作成を行い、一部修正している資料です。

## 1. はじめに

### 1.1 目的
本運用は、本番データベース（以下、本番DB）のデータ肥大化によるパフォーマンス低下を防止することを目的とする。
作成から10年以上経過したデータを別サーバーの「保管用データベース（以下、保管用DB）」へ完全移行し、本番DBからは当該データを削除する。

### 1.2 用語の定義
本要領書で使用する用語を以下の通り定義する。

* **本番DB**
    * 現在業務で使用稼働中のメインデータベース。サーバーA（本番機）にて稼働。
* **保管用DB**
    * 過去データを長期保存し、必要に応じて参照するためのデータベース。サーバーB（保管機）にて稼働。
* **作業用DB**
    * データ移行作業のために一時的に使用するデータベース。サーバーA（本番機）の本番DBと同一インスタンス上に作成し、データの抽出・一時保持に使用する。

### 1.3 実施概要
* **実施頻度**: 3年に1回
* **実施方式**: 手動実行（SQL Server Management Studio等を使用）
* **対象データ**: 基準年度より10年以上前の「年度」を持つ全レコード

### 1.4 システム構成とデータフロー
本作業では、ネットワーク負荷と処理時間を最適化するため、以下の2段階で移行を行う。

1. **サーバーA（本番機）内**: 本番DB → 作業用DBへデータコピー
2. **サーバー間**: 作業用DBをバックアップ → サーバーB（保管機）へリストア
3. **サーバーA（本番機）内**: 本番DBからデータ削除

---

## 2. 事前準備フェーズ

作業実施の数日前～直前に実施する。

### 2.1 環境確認
* **サーバーA（本番機）**:
    * 作業用DBの領域確保（削除対象データ量と同等の空き容量が必要）
* **サーバーB（保管機）**:
    * リストア用のディスク空き容量確認
    * SQL Serverのバージョン確認（サーバーAと同等以上であること）

### 2.2 変数の決定
作業当日に使用する「基準年度」を決定する。
* 例：2025年度末に実施し、2014年度以前を削除対象とする場合 → `@TargetYear = 2014`

### 2.3 【重要】本番DBの完全バックアップ
作業直前に、万が一のデータ損失に備えて本番DBのフルバックアップを取得する。

```sql
-- サーバーAで実行
BACKUP DATABASE [本番DB名] 
TO DISK = 'X:\Backup\ProdDB_Full_BeforeDelete.bak' 
WITH INIT, COMPRESSION, STATS = 10;

```

---

## 3. 実行フェーズ①：データの退避（アーカイブ）

### 3.1 作業用DBへのデータコピー（サーバーA）

本番DBから同一サーバー内の作業用DBへデータをコピーする。
※ネットワーク経由のコピーより高速かつ低負荷であるため。

```sql
-- サーバーAで実行
DECLARE @TargetYear INT = 2014; -- ★対象年度を指定

-- 1. 親テーブルのコピー
INSERT INTO [作業用DB].[dbo].[親テーブル]
SELECT * FROM [本番DB].[dbo].[親テーブル]
WHERE 年度 <= @TargetYear;

-- 2. 子テーブルのコピー
INSERT INTO [作業用DB].[dbo].[子テーブル]
SELECT * FROM [本番DB].[dbo].[子テーブル]
WHERE 年度 <= @TargetYear;

```

* **確認**: コピーされた件数が想定通りか確認する。

### 3.2 作業用DBのバックアップ（サーバーA）

データコピーが完了した作業用DBをファイルにダンプする。

```sql
-- サーバーAで実行
DECLARE @BackupFile NVARCHAR(255);
-- 日付つきファイル名
SET @BackupFile = 'X:\Backup\WorkDB_Transfer_' + CONVERT(VARCHAR(8), GETDATE(), 112) + '.bak';

BACKUP DATABASE [作業用DB] 
TO DISK = @BackupFile 
WITH INIT, COMPRESSION;

```

### 3.3 バックアップファイルの転送

* 作成された `.bak` ファイルを、サーバーAからサーバーBの所定フォルダへコピー（Windowsファイルコピー等）する。

### 3.4 別サーバーへのリストア（サーバーB）

サーバーBにてデータベースを復元し、保管用DB（アーカイブ環境）を更新・構築する。

```sql
-- サーバーBで実行
-- ファイルパスはサーバーBの環境に合わせて変更すること
RESTORE DATABASE [保管用DB]
FROM DISK = 'Y:\Restore\WorkDB_Transfer_yyyymmdd.bak'
WITH REPLACE,
MOVE 'WorkDB_Data' TO 'Y:\Data\ArchiveDB.mdf', -- データファイルの配置先
MOVE 'WorkDB_Log'  TO 'Y:\Log\ArchiveDB.ldf';  -- ログファイルの配置先

```

### 3.5 ユーザーアクセスの復旧（サーバーB）

別サーバーへ移行したことで切断されたユーザー紐付け（孤立ユーザー）を解消する。

```sql
-- サーバーBで実行
USE [保管用DB];
-- 例：参照用ユーザー 'RefUser' を修復
ALTER USER [RefUser] WITH LOGIN = [RefUser];

```

* **確認**: サーバーBの保管用DBで、過去データが正しく参照できることを確認する。**ここでの確認が完了するまで、次の削除フェーズに進んではならない。**

---

## 4. 実行フェーズ②：本番データの削除

サーバーBへの退避完了確認後、サーバーAの本番DBからデータを削除する。

### 4.1 バッチ削除の実行（サーバーA）

トランザクションログの肥大化とテーブルロックを防ぐため、少しずつ削除する。
**※削除順序厳守: 子テーブル（参照元） → 親テーブル（参照先）**

```sql
-- サーバーAで実行
DECLARE @TargetYear INT = 2014; -- ★対象年度を指定（コピー時と同じ値）
DECLARE @DeletedRows INT;

-- 1. 子テーブルの削除（ループ処理）
SET @DeletedRows = 1;
WHILE (@DeletedRows > 0)
BEGIN
    DELETE TOP (10000) -- 1回あたり1万件
    FROM [本番DB].[dbo].[子テーブル]
    WHERE 年度 <= @TargetYear;

    SET @DeletedRows = @@ROWCOUNT;
    WAITFOR DELAY '00:00:02'; -- 2秒待機（負荷調整）
END

-- 2. 親テーブルの削除（ループ処理）
SET @DeletedRows = 1;
WHILE (@DeletedRows > 0)
BEGIN
    DELETE TOP (10000)
    FROM [本番DB].[dbo].[親テーブル]
    WHERE 年度 <= @TargetYear;

    SET @DeletedRows = @@ROWCOUNT;
    WAITFOR DELAY '00:00:02';
END

```

---

## 5. 事後メンテナンス・クリーンアップフェーズ

### 5.1 インデックス再構築と統計情報更新（サーバーA）

削除による断片化を解消し、パフォーマンスを回復させる。**（必須作業）**

```sql
-- サーバーAで実行
-- 1. インデックス再構築
ALTER INDEX ALL ON [本番DB].[dbo].[子テーブル] REBUILD;
ALTER INDEX ALL ON [本番DB].[dbo].[親テーブル] REBUILD;

-- 2. 統計情報の更新
UPDATE STATISTICS [本番DB].[dbo].[子テーブル] WITH FULLSCAN;
UPDATE STATISTICS [本番DB].[dbo].[親テーブル] WITH FULLSCAN;

```

### 5.2 サーバーAの作業領域解放

移行に使用したサーバーA上の作業用DB内のデータを削除（またはDBごと削除）し、容量を空ける。

```sql
-- サーバーAで実行
-- 次回利用のために枠だけ残す場合はTRUNCATE
TRUNCATE TABLE [作業用DB].[dbo].[子テーブル];
TRUNCATE TABLE [作業用DB].[dbo].[親テーブル];

```

---

## 6. 最終確認・緊急時対応

### 6.1 最終動作確認

1. **本番DB**: アプリケーションから直近データが正常に参照・更新できること。
2. **保管用DB**: サーバーBにて過去データが参照できること。

### 6.2 障害時の切り戻し

* 作業中に致命的なエラーやデータ整合性の不一致が発生した場合、手順2.3で取得した「本番DBの完全バックアップ」を使用してリストアを行う。

以上

```

```
